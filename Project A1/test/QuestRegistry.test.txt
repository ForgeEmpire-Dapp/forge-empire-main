const { expect } = require("chai");
const { ethers, upgrades } = require("hardhat");

describe("QuestRegistry", function () {
  let owner, questAdmin, pauser, upgrader, questSigner, progressRecorder, user, other;
  let xpEngine, badgeMinterMock, questRegistry;

  beforeEach(async function () {
    [owner, questAdmin, pauser, upgrader, questSigner, progressRecorder, user, other] = await ethers.getSigners();

    // Deploy XPEngine as upgradeable (if Initializable/UUPS)
    const XPEngine = await ethers.getContractFactory("XPEngine");
    xpEngine = await upgrades.deployProxy(XPEngine, [], { initializer: "initialize" });
    await xpEngine.waitForDeployment();

    // Deploy MockBadgeMinter
    const MockBadgeMinter = await ethers.getContractFactory("MockBadgeMinter");
    badgeMinterMock = await MockBadgeMinter.deploy();
    await badgeMinterMock.waitForDeployment();

    // Deploy QuestRegistry (upgradeable)
    const QuestRegistry = await ethers.getContractFactory("QuestRegistry");
    questRegistry = await upgrades.deployProxy(
      QuestRegistry,
      [
        owner.address,
        questAdmin.address,
        pauser.address,
        upgrader.address,
        questSigner.address,
        xpEngine.address,
        badgeMinterMock.address
      ],
      { initializer: "initialize" }
    );
    await questRegistry.waitForDeployment();

    // Grant PROGRESS_RECORDER_ROLE to progressRecorder
    const PROGRESS_RECORDER_ROLE = await questRegistry.PROGRESS_RECORDER_ROLE();
    await questRegistry.grantRole(PROGRESS_RECORDER_ROLE, progressRecorder.address);
  });

  describe("Deployment & Roles", function () {
    it("Should set roles correctly", async function () {
      const QUEST_ADMIN_ROLE = await questRegistry.QUEST_ADMIN_ROLE();
      expect(await questRegistry.hasRole(QUEST_ADMIN_ROLE, questAdmin.address)).to.be.true;

      const PAUSER_ROLE = await questRegistry.PAUSER_ROLE();
      expect(await questRegistry.hasRole(PAUSER_ROLE, pauser.address)).to.be.true;

      const UPGRADER_ROLE = await questRegistry.UPGRADER_ROLE();
      expect(await questRegistry.hasRole(UPGRADER_ROLE, upgrader.address)).to.be.true;

      const QUEST_SIGNER_ROLE = await questRegistry.QUEST_SIGNER_ROLE();
      expect(await questRegistry.hasRole(QUEST_SIGNER_ROLE, questSigner.address)).to.be.true;
    });
  });

  describe("Quest Lifecycle", function () {
    it("Should create a REFERRAL quest", async function () {
      const questType = 1; // REFERRAL
      const description = "Invite 3 friends";
      const parameters = ethers.utils.defaultAbiCoder.encode(["uint256"], [3]);
      const xpReward = 100;
      const badgeId = 1;
      const isRepeatable = false;

      await questRegistry.connect(questAdmin).createQuest(
        questType,
        description,
        parameters,
        xpReward,
        badgeId,
        isRepeatable
      );

      const quest = await questRegistry.getQuest(1);
      expect(quest.id).to.equal(1);
      expect(quest.description).to.equal(description);
      expect(quest.questType).to.equal(questType);
    });

    it("Should record progress and complete quest", async function () {
      // Create a REFERRAL quest requiring 3 invites
      const questType = 1; // REFERRAL
      const description = "Invite 3 friends";
      const parameters = ethers.utils.defaultAbiCoder.encode(["uint256"], [3]);
      const xpReward = 100;
      const badgeId = 1;
      const isRepeatable = false;

      await questRegistry.connect(questAdmin).createQuest(
        questType,
        description,
        parameters,
        xpReward,
        badgeId,
        isRepeatable
      );

      // Record partial progress
      await questRegistry.connect(progressRecorder).recordProgress(user.address, 1, 2);
      let progress = await questRegistry.userQuestProgress(user.address, 1);
      expect(progress).to.equal(2);

      // Complete the quest
      await questRegistry.connect(progressRecorder).recordProgress(user.address, 1, 1);

      // User quest completion should now be true
      const completed = await questRegistry.userQuestCompleted(user.address, 1);
      expect(completed).to.be.true;
    });
  });

  describe("Pause & Unpause", function () {
    it("Should allow pauser to pause and unpause", async function () {
      await questRegistry.connect(pauser).pause();
      expect(await questRegistry.paused()).to.be.true;

      await questRegistry.connect(pauser).unpause();
      expect(await questRegistry.paused()).to.be.false;
    });
  });
});
